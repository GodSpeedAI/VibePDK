#!/usr/bin/env bash
# shell=bash
# direnv configuration for the rendered project
# Keep secrets out of VCS; prefer .envrc.local for sensitive overrides.

# Use direnv to automatically load Python and Node
use python {{ cookiecutter.python_version }}
# Prefer Volta for Node if available, else fallback to direnv's `use node`
export VOLTA_HOME="${VOLTA_HOME:=$HOME/.volta}"
export PATH="$VOLTA_HOME/bin:$PATH"
if command -v volta >/dev/null 2>&1; then
  : "using Volta-managed Node"
else
  use node 24
fi

# Core project settings
export DOMAIN_FILE="${DOMAIN_FILE:=$PWD/domain/domain.yaml}"
export CALM_FILE="${CALM_FILE:=$PWD/architecture/calm/system.calm.json}"
export CALM_PATTERNS_DIR="${CALM_PATTERNS_DIR:=$PWD/architecture/calm/patterns}"
export DOCKER_REGISTRY="${DOCKER_REGISTRY:=ghcr.io/my-org}"

# Optional: project description and author (used by hooks)
export PROJECT_NAME="${PROJECT_NAME:={{ cookiecutter.project_slug }}}"
export PROJECT_DESCRIPTION="${PROJECT_DESCRIPTION:={{ cookiecutter.description }}}"
export AUTHOR_NAME="${AUTHOR_NAME:={{ cookiecutter.author_name }}}"

# Nx settings
export NX_CLOUD_ACCESS_TOKEN="${NX_CLOUD_ACCESS_TOKEN:=}"
export NX_CACHE_ENABLED="${NX_CACHE_ENABLED:=true}"
export NX_DAEMON="${NX_DAEMON:=false}"

# Application environment
export APP_ENV="${APP_ENV:=development}"
export DATABASE_URL="${DATABASE_URL:=postgresql://user:password@localhost:5432/mydb}"
export REDIS_URL="${REDIS_URL:=redis://localhost:6379/0}"
export SECRET_KEY="${SECRET_KEY:=replace_with_a_real_secret}"

# Thirdâ€‘party tokens (leave blank or load securely)
export GITHUB_MCP_TOKEN="${GITHUB_MCP_TOKEN:=}"
export OPENAI_API_KEY="${OPENAI_API_KEY:=}"

# Misc (set to UTC for reproducible snapshots)
export TZ="${TZ:=UTC}"
export PYTHONUTF8="${PYTHONUTF8:=1}"

# Local tool PATHs
if [ -d "$PWD/tools/transformers" ]; then
  export PATH="$PWD/tools/transformers:$PATH"
fi

# Load .env if present
layout dotenv .env 2>/dev/null || true

# Local overrides (ignored by git)
if [ -f .envrc.local ]; then
  source_env .envrc.local
fi
